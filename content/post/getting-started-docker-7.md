---
title: "docker入门实战之七:联合文件系统"
date: 2019-09-18T10:35:41+08:00
draft: false
tags: ["docker"]
categories: "container"
toc: true
---

&emsp;联合文件系统是一种文件系统服务，可以应用于Linux、FreeBSD和NetBSD操作系统，能够将这些文件系统联合挂载到一个文件系统。它允许文件和目录这类单独的文件系统（在联合文件系统中称为分支），透明地叠加成一个连贯的文件系统。同一个路径下，不同目录的内容可以整合成一个分支，它们会以一种新的虚拟文件系统的方式，合并在一个的目录中。

&emsp;在新虚拟文件系统中，我们看似可以对文件进行操作，但是实际上我们并有没有改变原来的文件，这涉及到联合文件系统中最重要的写时复制(copy-on-write)。写时复制，也称为隐式共享。它是一种资源管理技术，可以对可修改资源实现高效复制。当一个资源重复，但并未修改的时候，这时候并不需要创建一个新的资源；这个资源可以由新旧资源共享。修改仍然需要一个副本，因此复制操作被推迟到第一次写入。通过这种共享资源的方式，可以显著减少未修改副本的资源消耗，但是也会为资源修改操作增加小部分的开销。

&emsp;我们用一个例子介绍这种联合文件系统的用途：历史上有一个Knoppix的Linux发行版， 主要由于Linux演示、光盘教学和商业产品演示。它不需要光盘安装，直接将CD/DVD的内容运行在一个可存储设备（例如:U盘）中，即将CD/DVD文件系统与U盘这样一个可写的文件系统联合起来。这样我们对CD/DVD的任何改动都会记录在U盘中，而不需要改变原来的东西。

&emsp;在Docker中，广泛地使用了这种联合文件系统。而下图很好地展示了Docker是如何用UnionFS搭建的分层镜像。

![docker的分层镜像](../images/docker/docker-filesystems-multilayer.png)

&emsp;上篇我们讲到了Dockerfile，我们可以知道Docker的镜像是由Dockerfile的一条条指令组合起来的。如上图一样，其实这每个指定在Docker联合文件系统中都是一层层的layer，也就是一个增量rootfs（一个目录）。这样镜像A含有Centos和java环境时，而某一用户需要java环境，那么他可以直接基于镜像A构建出新的镜像B。这样镜像A和镜像B生成的容器A和容器B就会公用相同的底层环境（Centos操作系统和java环境），UnionFS会将相关的层挂载到同一目录，作为容器的跟文件系统。

&emsp;各个版本操作系统默认支持的联合文件系统都不一样，例如:在Ubuntu中默认为aufs，在Centos中默认为devicemapper。                                                                                                                                                                                                          