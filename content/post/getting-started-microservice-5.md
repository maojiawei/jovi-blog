---
title: "微服务架构系列：负载均衡"
date: 2019-12-03T17:03:26+08:00
draft: false
categories: "microservice"
toc: true
---
&emsp;经过前几章的内容，我们有了注册中心，可以进行服务远程调用。那么，现在我们要考虑的问题是，当服务提供者有多个的时候，服务消费者应该如何选择哪个服务提供者提供服务。这个问题就是我们今天要研究的负载均衡。

&emsp;负载均衡的本质是通过合理的算法将请求分摊到多个服务节点，以增加吞吐量。负载均衡按照类别可以分为服务端负载均衡和客户端负载均衡。

### 1.0 服务端负载均衡
&emsp;服务端负载均衡会存在一个单独的服务，该服务维护一个可用的应用服务器列表和负载均衡器。当负载均衡器接收到客户端请求时，会通过负载均衡算法将请求发送到对应的服务器中。

![服务端负载均衡.jpg](../images/microservice/服务端负载均衡.jpg)

#### 1.1 四层服务端负载均衡
&emsp;四层负载均衡的传输一般集中在传输层（OSI模型第四层），它是通过修改报文中的目标地址和端口号，将请求转发至合适的应用服务器。

&emsp;四层负载均衡的性能强于七层负载均衡，F5和LVS是四层负载均衡中最常用的产品。

#### 1.2 七层服务端负载均衡
&emsp;七层负载均衡通过解析报文中应用层内容，再将请求转发至合适的应用服务器。在七层负载均衡中，Nginx是最常用的产品。

&emsp;相比于四层负载均衡，七层负载均衡能够充分解析应用层协议的内容，转发方式更加灵活。

### 2.0 客户端负载均衡

&emsp;服务端负载均衡需要自己维护应用服务列表。但是微服务架构下，服务的动态伸缩使得服务数量和IP地址经常发生变化。这对于服务端而言，无法适应这种变化。

&emsp;客户端负载均衡就是由客户端来选择连接到哪个服务器，而不是由客户端连接到一个服务端地址再由服务器分发请求。

![客户端负载均衡](../images/microservice/客户端负载均衡.jpg)

&emsp;优势在于: 客户端负载均衡直接将负载均衡器绑定在客户端中，避免了**二次转发带来的网络间消耗**。同时，绕过了中心化的服务端，**无需考虑中心节点**。

&emsp;问题在于程序复杂度会增加，不同语言构建的系统之间的负载均衡无法透明化。


### 3.0 负载均衡算法

&emsp;一般来说，负载均衡算法有以下几种：

- **随机算法**就是从可用的服务节点中，随机挑选一个服务进行访问。
- **轮询算法**就是按照固定的顺序，将可用的服务节点，轮流访问一遍。
- **加权轮询算法**就是给每个可用节点赋予权重，使得每个节点的访问概率不同，权重大的访问频率高。
- **最少活跃连接算法**就是每一次访问都选择连接数最少的节点。
- **一致性hash算法**就是同一个客户端来的请求始终访问同一服务节点。
